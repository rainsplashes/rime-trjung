# Rime schema
# encoding: utf-8

schema:
  schema_id: trjungkux
  name: 中古漢語（雨濺拼法）
  version: "0.1.0"
  author:
    - rainsplashes
  description: |
    中古漢語輸入方案，採用雨濺拼法
  dependencies:
    - luna_pinyin
    - stroke

switches:
  - name: ascii_mode
    reset: 0
    states: [ 中文, 西文 ]
  - name: full_shape
    states: [ 半角, 全角 ]
  - name: simplification
    states: [ 漢字, 汉字 ]
  - name: ascii_punct
    states: [ 。，, ．， ]

engine:
  processors:
    - ascii_composer
    - recognizer
    - key_binder
    - speller
    - punctuator
    - selector
    - navigator
    - express_editor
  segmentors:
    - ascii_segmentor
    - matcher
    - affix_segmentor@luna_pinyin
    - affix_segmentor@stroke
    - abc_segmentor
    - punct_segmentor
    - fallback_segmentor
  translators:
    - punct_translator
    - script_translator
    - script_translator@luna_pinyin
    - table_translator@stroke
    - table_translator@custom_phrase
  filters:
    - simplifier
    - uniquifier
    - reverse_lookup_filter@reverse_lookup

speller:
  alphabet: abdefghijklmnopqrstuvwxyzXH'+
  delimiter: ";"
  algebra:
    __include: polyhedron2rs
    __append:
      - derive/X/x/
      - derive/H/h/
      - derive/'//
      - derive/\+/v/
      - derive/Q/q/
      - derive/F/f/
      # 簡拼
      - abbrev/\b([a-z']).+$/$1/
      - abbrev/\b([ptk]h||ng|t?sy?r?h?|d?zy?r?|[dtn]r|ny).+$/$1/

translator:
  dictionary: zyenpheng
  prism: dzjwenpheng2
  spelling_hints: 5
  comment_format:
    __include: polyhedron2rs
    __append:
      - derive/;/ /
  preedit_format:
    - derive/(?<!\d)x\d/X/
    - derive/(?<!\d)h\d/H/
    - derive/(\d)([aeiouwj])/'$2/
    - derive/v/+/
    - derive/;/ /

luna_pinyin:
  tag: luna_pinyin
  dictionary: luna_pinyin
  enable_user_dict: false
  prefix: '`'
  suffix: ";"
  tips: 〔反查〕
  preedit_format:
    - xform/([nl])v/$1ü/
    - xform/([nl])ue/$1üe/
    - xform/([jqxy])v/$1u/

stroke:
  tag: stroke
  dictionary: stroke
  enable_user_dict: false
  prefix: '`'
  suffix: ";"
  tips: 〔反查〕
  preedit_format:
    - xlit/hspnz/一丨丿丶乙/

custom_phrase:
  dictionary: ""
  user_dict: custom_phrase
  db_class: stabledb
  enable_completion: false
  enable_sentence: false
  initial_quality: 1

reverse_lookup:
  tags: [luna_pinyin, stroke]
  overwrite_comment: true
  dictionary: zyenpheng
  comment_format:
    __include: polyhedron2rs

punctuator:
  import_preset: symbols

key_binder:
  import_preset: default

recognizer:
  import_preset: default
  patterns:
    punct: "^/([0-9]|10|[A-Za-z]+)$"
    luna_pinyin: "`[hspnz]*[aeiouv][a-z]*'?$|`[a-gi-moqrt-y][a-z]*;?$"
    stroke: "`[hspnz]+;?$"

polyhedron2rs:
  - "xform/'//"
  # 聲母
  - xform/\b(t|c)h(r|j)/$1$2h/
  - xform/\bc/ts/
  - xform/\bz/dz/
  - xform/\bdzs/z/
  - xform/\b(ts|dz|s|z|n)?j(h?)/$1Y$2j/
  - xform/\bh/x/
  - xform/\bgh/h/
  - xform/\bi/hj/
  - xform/\by/hy/
  # 介音
  - xform/u([aeou])/w$1/
  - xform/\b(kh?|g|ng|x|q)jye/$1jwie/
  - xform/\b(kh?|g|ng|x|q)ye/$1jwe/
  - xform/\b(kh?|g|ng|x|q)jy([int])/$1jwi$2/
  - xform/\b(kh?|g|ng|x|q)y([int])/$1wi$2/
  - xform/\b(ph?|b|m|kh?|g|ng|x|q)je/$1jie/
  - xform/y/jw/
  - xform/(?<!j|w)i([aeou])/j$1/
  - xform/(rh?w?)a/$1ae/
  - xform/(rh?w?)e/$1ea/
  #- xform/\b(ph?|b|m|kh?|g|ng|x|h|q)r(w?)([ae])/$1$2$3/
  # fix - added l so that lrangX can change to laengX
  - xform/\b(l|ph?|b|m|kh?|g|ng|x|h|q)r(w?)([ae])/$1$2$3/
  # 通攝
  - xform/wu(ng|k)/ow$1/
  - xform/(?<!r|h)u(ng|k)/uw$1/
  - xform/(?<!r)hu(ng|k)/huw$1/
  # 宕攝
  - xform/\b(ph?|b|m)jwa(ng|k)/$1ja$2/
  # 江攝
  - xform/r(h?)u(ng|k)/r$1aew$2/
  - xform/\b(ph?|b|m|kh?|g|ng|x|h|q)raew(ng|k)/$1aew$2/
  # 止攝
  - xform/ii(\b|x|h)/ij$1/
  - xform/(jw?)oi(\b|x|h)/$1Ij$2/
  - xform/\b(ph?|b|m)jwIj(\b|x|h)/$1jIj$2/
  - xform/jwi(\b|x|h)/wij$1/
  # 遇攝
  - xform/jwo(\b|x|h)/jU$1/
  - xform/(?<!j|w)o(\b|x|h)/U$1/
  # 蟹攝
  - xform/(?<!a|j|i|w)e(\b|x|h)/ej$1/
  - xform/(?<!j)we(\b|x|h)/wej$1/
  - xform/d\b/jh/
  - xform/ae(i|ix|ih)\b/ea$1/
  - xform/(?<!e)a(i|ix|ih)\b/o$1/
  - xform/(jw?)ajh\b/$1ojh/
  - xform/\b(ph?|b|m)jwojh\b/$1jojh/
  - xform/(a|e|o)i(\b|x|h)/$1j$2/
  # 臻攝
  - xform/jo(n|t)(\b|x|h)/jI$1$2/
  - xform/jwo(n|t)(\b|x|h)/ju$1$2/
  - xform/jw(n|t)(\b|x|h)/wi$1$2/
  # 山攝
  - xform/\b(ph?|b|m)wa(n|t)(\b|x|h)/$1a$2$3/
  - xform/(jw?)a(n|t)(\b|x|h)/$1o$2$3/
  - xform/\b(ph?|b|m)jwo(n|t)(\b|x|h)/$1jo$2$3/
  # 效攝
  - xform/([ae])u(\b|x|h)/$1w$2/
  # 果攝
  - xform/\b(ph?|b|m)wa(\b|x|h)/$1a$2/
  # 假攝
  - xform/ja(\b|x|h)/jae$1/
  - xform/\b(kh?|g)jae(\b|x|h)/$1ja$2/
  # 梗攝
  - xform/\b(ph?|b|m|kh?|g|ng|x|h|q)(jw?)e(ng|k)/$1$2ae$3/
  - xform/\b(t?s|d?z)(rh?j)e(ng|k)/$1$2ae$3/
  # 曾攝
  - xform/jwk/wik/
  # had to add this because zyenpheng.dict strangely includes both -iik and -ik? (prob a bug because there is no iing, and wang renxu qieyun doesn't distinguish iik and ik)
  - xform/iik/ik/
  # 流攝
  - xform/(?<!a|e)u(\b|x|h)/uw$1/
  - xform/jw(\b|x|h)/jiw$1/
  # 咸攝
  - xform/ja(m|p)/jae$1/
  - xform/jwa(m|p)/jo$1/

  - xform/q/'/

  #moved part of it to end because it will be needed later
  - xlit/YU/yu/
  - xform/y(h?)j+/y$1/
  - xform/x\b/X/
  - xform/h\b/H/

  # custom modifications

  # initials (extra Q added as separator)
  # h written as gh
  - xform/\bh/ghQ/
  # x written as h
  - xform/\bx/hQ/
  # ' now written as nothing
  #- xform/\bq/Q/
  - xform/[']/Q/
  # special rules for moving aspiration: tsyh > tshy
  #tsrh > tshr
  #trh > thr
  - xform/\btsyh(?!Q)/tshyQj/
  - xform/\btsrh(?!Q)/tshrQ/
  - xform/\btrh(?!Q)/thrQ/
  # palatal initials go from sy- to syQj- (the Q is temproary, the extra j is to make final conversion easier)
  - xform/\b(dzy|ny|tsy|sy|zy|y)(?!Q)/$1Qj/
  # add an extra Q to all other initials to make final analysis easier
  # unordered list for reference below (25 initials) + 11 above = 36 total
  # xform/^(?!.*Q)\b(p|ph|b|m|t|th|d|n|tr|dr|nr|ts|tsh|dz|s|z|tsr|dzr|sr|zr|k|kh|g|ng|l)(?!Q)/$1Q/
  # this list has to be ordered so we get tsQ and not tQs if t rule applies before ts rule
  # (?!hQ) prevents gh from becoming gQhQ, dzy from becoming dQzyQ, same logic for all others
  - xform/\b(tsr|tr|tsh|ts|th|t|sr|s|zr|z|dzr|dz|dr|d|nr|ng|n|ph|p|b|kh|k|g|m|l)(?!Q|hQ|yQ|rQ|syQ|shyQ|hyQ|hrQ|shrQ|hrQ|zyQ)/$1Q/

  # now all initials should end with Q, meaning all finals are after the Q
  # finals (the extra ending F is temproary so it marks a final as already changed)
  # 通攝
  # -uwng/k > -ung/k
  - xform/Quw(ng|k)(?!F)/Qu$1F
  # -juwng/k > -jung/k
  - xform/Qjuw(ng|k)(?!F)/Qju$1F
  # -owng/k > -uong/k
  - xform/Qow(ng|k)(?!F)/Quo$1F
  # -jowng/k > -juong/k
  - xform/Qjow(ng|k)(?!F)/Qjuo$1F

  # 江攝
  # -aewng/k > -rong/k
  - xform/Qaew(ng|k)(?!F)/Qro$1F

  # 止攝
  # -jie > ie (chongniu rewrite)
  - xform/Qjie(?!F)(\b|X|H)/QieF$1
  # -jwie > wie
  - xform/Qjwie(?!F)(\b|X|H)/QwieF$1
  # -je > rie (chongniu rewrite)
  - xform/Qje(?!F)(\b|X|H)/QrieF$1
  # -jwe > rwie
  - xform/Qjwe(?!F)(\b|X|H)/QrwieF$1

  # -jij > i
  - xform/Qjij(?!F)(\b|X|H)/QiF$1
  # -jwij > wi
  - xform/Qjwij(?!F)(\b|X|H)/QwiF$1
  # -ij > ri
  - xform/Qij(?!F)(\b|X|H)/QriF$1
  # -wij > rwi
  - xform/Qwij(?!F)(\b|X|H)/QrwiF$1

  # -i > ii (the extra j? can come from tsyQji)
  - xform/Qj?i(?!F)(\b|X|H)/QiiF$1

  # -j+j > iij
  - xform/QjIj(?!F)(\b|X|H)/QiijF$1
  # -jw+j > wii
  - xform/QjwIj(?!F)(\b|X|H)/QwiijF$1

  # 遇攝
  # -u > uo
  - xform/Qu(?!F)(\b|X|H)/QuoF$1
  # -ju > juo
  - xform/Qju(?!F)(\b|X|H)/QjuoF$1

  # 蟹攝
  # -aej > raj
  - xform/Qaej(?!F)(\b|X|H)/QrajF$1
  # -waej > rwaj
  - xform/Qwaej(?!F)(\b|X|H)/QrwajF$1
  # -eaj > rej
  - xform/Qeaj(?!F)(\b|X|H)/QrejF$1
  # -weaj > rwej
  - xform/Qweaj(?!F)(\b|X|H)/QrwejF$1
  # -ea > re
  - xform/Qea(?!F)(\b|X|H)/QreF$1
  # -wea > rwe
  - xform/Qwea(?!F)(\b|X|H)/QrweF$1
  # -jiej > jej
  - xform/Qjiej(?!F)(\b|X|H)/QjejF$1
  # -jwiej > jwej
  - xform/Qjwiej(?!F)(\b|X|H)/QjwejF$1
  # -jej > rjej
  - xform/Qjej(?!F)(\b|X|H)/QrjejF$1
  # -jwej > rjwej
  - xform/Qjwej(?!F)(\b|X|H)/QrjwejF$1

  # 臻攝
  # -jin/t > in/t
  - xform/Qji(n|t)(?!F)(\b|X|H)/Qi$1F$2
  # -in > rin
  - xform/Qi(n|t)(?!F)(\b|X|H)/Qri$1F$2
  # -jwin > win
  - xform/Qjwi(n|t)(?!F)(\b|X|H)/Qwi$1F$2
  # -win > rwin
  - xform/Qwi(n|t)(?!F)(\b|X|H)/Qrwi$1F$2
  # -j+n/t > iin/t
  - xform/QjI(n|t)(?!F)(\b|X|H)/Qii$1F$2

  # 山攝
  # -aen/t > ran/t
  - xform/Qae(n|t)(?!F)(\b|X|H)/Qra$1F$2
  # -waen > rwan
  - xform/Qwae(n|t)(?!F)(\b|X|H)/Qrwa$1F$2
  # -ean/t > ren/t
  - xform/Qea(n|t)(?!F)(\b|X|H)/Qre$1F$2
  # -wean > rwen
  - xform/Qwea(n|t)(?!F)(\b|X|H)/Qrwe$1F$2
  # -jien > jen
  - xform/Qjie(n|t)(?!F)(\b|X|H)/Qje$1F$2
  # -jwien > jwen
  - xform/Qjwie(n|t)(?!F)(\b|X|H)/Qjwe$1F$2
  # -jen > rjen
  - xform/Qje(n|t)(?!F)(\b|X|H)/Qrje$1F$2
  # -jwen > rjwen
  - xform/Qjwe(n|t)(?!F)(\b|X|H)/Qrjwe$1F$2

  # 效攝
  # -aew > raw
  - xform/Qaew(?!F)(\b|X|H)/QrawF$1
  # -jiew > jew
  - xform/Qjiew(?!F)(\b|X|H)/QjewF$1
  # -jew > rjew
  - xform/Qjew(\b|X|H)/QrjewF$1

  # 果攝 (no changes)

  # 假攝
  # -ae > ra
  - xform/Qae(?!F)(\b|X|H)/QraF$1
  # -wae > rwa
  - xform/Qwae(?!F)(\b|X|H)/QrwaF$1
  # -jae > ja (no distinction between ja and jae)
  - xform/Qjae(?!F)(\b|X|H)/QjaF$1

  # 宕攝 (no changes)

  # 梗攝
  # -aeng/k > rang/k  
  - xform/Qae(ng|k)(?!F)(\b|X|H)/Qra$1F$2
  # -waeng > rwang
  - xform/Qwae(ng|k)(?!F)(\b|X|H)/Qrwa$1F$2
  # -jaeng > rjang
  - xform/Qjae(ng|k)(?!F)(\b|X|H)/Qrja$1F$2
  # -jwaeng > rjwang
  - xform/Qjwae(ng|k)(?!F)(\b|X|H)/Qrjwa$1F$2
  # -eang/k > reng/k  
  - xform/Qea(ng|k)(?!F)(\b|X|H)/Qre$1F$2
  # -weang > rweng
  - xform/Qwea(ng|k)(?!F)(\b|X|H)/Qrwe$1F$2
  # -jieng/k > jeng/k (make 清 always spelled the same)
  - xform/Qjie(ng|k)(?!F)(\b|X|H)/Qje$1F$2
  # -jwieng > jweng
  - xform/Qjwie(ng|k)(?!F)(\b|X|H)/Qjwe$1F$2

  # 曾攝 (no changes)

  # 流攝
  # -juw > jow
  - xform/Qjuw(?!F)(\b|X|H)/QjowF$1
  # -uw > ow
  - xform/Quw(?!F)(\b|X|H)/QowF$1
  # -jiw > iw
  - xform/Qjiw(?!F)(\b|X|H)/QiwF$1

  # 深攝
  # -jim/p > im/p
  - xform/Qji(m|p)(?!F)(\b|X|H)/Qi$1F$2
  # -im > rim
  - xform/Qi(m|p)(?!F)(\b|X|H)/Qri$1F$2

  # 咸攝
  # -jaem/p > jom/p (no distinction between jom and jaem)
  - xform/Qjae(m|p)(?!F)(\b|X|H)/Qjo$1F$2
  # -aem > ram
  - xform/Qae(m|p)(?!F)(\b|X|H)/Qra$1F$2
  # -eam > rem
  - xform/Qea(m|p)(?!F)(\b|X|H)/Qre$1F$2
  # -jiem > jem
  - xform/Qjie(m|p)(?!F)(\b|X|H)/Qje$1F$2
  # -jem > rjem
  - xform/Qje(m|p)(?!F)(\b|X|H)/Qrje$1F$2


  # post processing
  # double r clusters > r (rQr > r)
  - xform/rQr/r

  # if r comes after a coronal, the chongniu processing was done incorrectly, undo it. this is because baxter -je is used to write both -rie and -ie depending on initial
  # (?!a) to allow laeng > lrang (division 2 is fine but rare)
  - xform/\b(tshy|dzy|tsy|t|th|d|n|ts|tsh|dz|s|z|l|y|ny|sy|zy)Qr(?!a)/$1Q/

  # yj clusters > y (yQj > y)
  # it is important that this rules comes after the previous one, because of input like yQrjep
  - xform/yQj/y

  # get rid of all other temp Q and F characters
  - xform/[QF]//

  # moved part of it to end because this rule is needed for later
  - xlit/I/+/
